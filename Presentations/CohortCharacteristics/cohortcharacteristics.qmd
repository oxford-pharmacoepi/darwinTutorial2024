---
title: "CohortCharacteristics"
subtitle: "Characterise cohorts"
format:
  revealjs: 
    theme: [simple, styleOU.scss]
    incremental: true   
    slide-number: true
    chalkboard: true
    preview-links: auto
    margin: 0.07
    code-link: true
    code-line-numbers: false
    height: 900
    width: 1600
    footer: "Conducting 'Off-The-Shelf' Characterization Studies Using DARWIN EU Tools and the OMOP CDM"
execute:
  echo: true
  eval: true
editor: visual
---

## CohortCharacteristics

![](https://github.com/darwin-eu-dev/CohortCharacteristics/blob/main/man/figures/logo.png?raw=true){fig-align="center"}

## Context

```{r, echo = FALSE}
options(width = 120)
```

. . .

This package aims to standardise and provide the tools to conduct Characterisation studies as of the Darwin-EU Catalogue of Standard Analytics.

![](https://www.benzifoundation.org/wp-content/uploads/2023/09/eu-darwin-1.png){fig-align="center"}

## Package overview

-   [v0.3.0 on cran](https://CRAN.R-project.org/package=CohortCharacteristics)

-   [package website](https://darwin-eu-dev.github.io/CohortCharacteristics/)

. . .

![](https://github.com/darwin-eu-dev/CohortCharacteristics/blob/main/man/figures/logo.png?raw=true){fig-align="center" width="5.5in"}

## Functions

-   [**summariseCohortCount**](https://darwin-eu-dev.github.io/PatientProfiles/reference/summariseCohortCount.html)

-   [**summariseCohortAttrition**](https://darwin-eu-dev.github.io/PatientProfiles/reference/summariseCohortAttrition.html)

-   [summariseCharacteristics](https://darwin-eu-dev.github.io/PatientProfiles/reference/summariseCharacteristics.html)

-   [summariseLargeScaleCharacteristics](https://darwin-eu-dev.github.io/PatientProfiles/reference/summariseLargeScaleCharacteristics.html)

-   [**summariseCohortOverlap**](https://darwin-eu-dev.github.io/PatientProfiles/reference/summariseCohortOverlap.html)

-   [**summariseCohortTiming**](https://darwin-eu-dev.github.io/PatientProfiles/reference/summariseCohortTiming.html)

## Workflow

We have three types of functions:

-   **summarise**: these functions produce an standardised output to summarise a cohort. This standard output is called summarised_result.

-   **plot**: these functions produce plots (currently, only ggplot, but working to implement plotly) from a summarised_result object.

-   **table**: these functions produce tables (gt and flextable) from a summarised_result object.

. . .

```{r, eval = FALSE}
result <- summariseXXX(...)
```

. . .

```{r, eval = FALSE}
tableXXX(result)
```

. . .

```{r, eval = FALSE}
plotXXX(result)
```

. . .

```{mermaid}
%%| echo: false
flowchart LR
  A[summarise function ] --> B[Plot function ]
  A --> C[Table function ]
```

## Create the cdm reference

```{r}
library(CDMConnector)
library(duckdb)

db <- dbConnect(duckdb(),  eunomiaDir())
cdm <- cdmFromCon(con = db, cdmSchema = "main", writeSchema = "main")
```

```{r, message=TRUE}
cdm
```

## Let's instantiate some cohorts

```{r}
library(CohortConstructor)

cdm <- generateConceptCohortSet(
  cdm = cdm,
  name = "sinusitis",
  conceptSet = list(
    "bacterial_sinusitis" = 4294548, 
    "viral_sinusitis" = 40481087, 
    "chronic_sinusitis" = 257012, 
    "any_sinusitis" = c(4294548, 40481087, 257012)
  ),
  end = 0,
  limit = "all"
)

```

## summariseCohortCount

. . .

Lets see the sinusitis cohorts

. . .

```{r}
cdm$sinusitis
```

## summariseCohortCount

. . .

Lets see the settings of the sinusitis cohorts

. . .

```{r}
cdm$sinusitis |> 
  settings() |> 
  print(n = Inf)
```

## summariseCohortCount

We can easily extract metadata about the counts in this cohort:

```{r}
cdm$sinusitis |> 
  cohortCount()
```

## summariseCohortCount

We can export this metadata using `summariseCohortCount`:

```{r}
library(CohortCharacteristics)
library(dplyr)
cdm$sinusitis |>
  summariseCohortCount() |>
  glimpse()
```

## tableCohortCount

We can easily create a gt or flextable from the output of summariseCohortCount:

```{r, warning=TRUE, message = TRUE}
result <- cdm$sinusitis |>
  summariseCohortCount(cohortId = 1:4)

tableCohortCount(result)
```

## tableCohortCount

You can easily suppress a summarised_result using the suppress function:

```{r}
cdm$sinusitis |>
  summariseCohortCount(cohortId = 1:4) |>
  suppress(minCellCount = 5) |>
  tableCohortCount()
```

## tableCohortCount

We can easily create a gt or flextable from the output of summariseCohortCount:

```{r}
cdm$sinusitis |>
  PatientProfiles::addSex() |>
  summariseCohortCount(strata = "sex") |>
  tableCohortCount(header = c("group"), groupColumn = "sex")
```

## export gt tables

[gt](https://gt.rstudio.com/) tables can easily be exported to word:

```{r}
myTable <- cdm$sinusitis |>
  PatientProfiles::addSex() |>
  summariseCohortCount(strata = "sex") |>
  tableCohortCount(header = c("group"), groupColumn = "sex")
```

. . .

```{r, eval=FALSE}
library(gt)
myTable |> gt::gtsave("table.docx")
```

![](word.png)

## summariseCohortAttrition

We can easily extract metadata about the attrition of a cohort:

```{r}
cdm$sinusitis |> attrition()
```

## summariseCohortAttrition

We can export this metadata using `summariseCohortAttrition`:

```{r}
cdm$sinusitis |>
  summariseCohortAttrition() |>
  glimpse()
```

## plotCohortAttrition

We can easily create a diagram from the output of summariseCohortAttrition:

```{r}
cdm$sinusitis |>
  summariseCohortAttrition() |>
  plotCohortAttrition()
```

## plotCohortAttrition

We can easily create a diagram from the output of summariseCohortAttrition:

```{r}
cdm$sinusitis |>
  summariseCohortAttrition() |>
  filter(group_level == "bacterial_sinusitis") |>
  plotCohortAttrition()
```

## Your turn

Can you create a cohort with the following attrition?

-   all records of sinusitis (4294548, 40481087, 257012)

-   only first record per person (requireIsFirstEntry)

-   restrict to female individuals (requireSex)

-   restrict to children between 5 and 12 years old (requireAge)

-   plot attrition (summariseCohortAttrition + plotCohortAttrition)

## Your turn

```{r, echo = FALSE}
cdm$my_cohort <- conceptCohort(cdm = cdm, conceptSet = list(sinusitis = c(4294548, 40481087, 257012)), name = "my_cohort") |>
  requireIsFirstEntry() |>
  requireSex(sex = "Female") |>
  requireAge(ageRange = c(5, 12))

cdm$my_cohort |> 
  summariseCohortAttrition() |>
  plotCohortAttrition()
```

## summariseCohortOverlap

summariseCohortOverlap identifies the overlap (number of subjects) between cohorts:

```{r}
result <- summariseCohortOverlap(cdm$sinusitis)
result |>
  glimpse()
```

## tableCohortOverlap

We can easily display them in a gt table with tableCohortOverlap:

. . .

```{r}
tableCohortOverlap(result)
```

## plotCohortOverlap

We can easily have a plot of the overlap with plotCohortOverlap:

. . .

```{r}
plotCohortOverlap(result, uniqueCombinations = FALSE)
```

## Your turn

Create 3 drug cohorts from these 5: - aspirin - acetaminophen - naproxen - amoxicillin - ibuprofen

Identify the subject overlap between them

## Your turn

Create 3 drug cohorts from these 5: - aspirin - acetaminophen - naproxen - amoxicillin - ibuprofen

*Remember there is a function in CodelistGenerator::getDrugIngredientCodes*

Identify the subject overlap between them and create a plot to show the overlap

## Your turn

```{r, echo = FALSE}
library(CodelistGenerator)
cdm$my_cohort <- conceptCohort(
  cdm = cdm, 
  conceptSet = getDrugIngredientCodes(cdm = cdm, name = c("aspirin", "acetaminophen", "amoxicillin")),
  name = "my_cohort")

cdm$my_cohort |>
  summariseCohortOverlap() |>
  plotCohortOverlap(uniqueCombinations = FALSE)
```

## summariseCohortTiming

We have a function to identify the time between cohorts to see which cohorts occur first compared to the other.

Lets create some medications cohorts:

```{r}
cdm$medications <- conceptCohort(
  cdm = cdm, 
  conceptSet = getDrugIngredientCodes(
    cdm = cdm, name = c("warfarin", "acetaminophen", "morphine")
  ),
  name = "medications"
)
```

## summariseCohortTiming

. . .

```{r, eval = F}
summaryTiming <- cdm$medications |>
  summariseCohortTiming(restrictToFirstEntry = TRUE)
summaryTiming |>
  glimpse()
```

. . .

```{r, eval = T, echo = F}
summaryTiming <- cdm$medications |>
  summariseCohortTiming(restrictToFirstEntry = TRUE)
summaryTiming |>
  glimpse()
```

## tableCohortTiming

. . .

```{r, eval = F}
summaryTiming |> tableCohortTiming(timeScale = "years")
```

. . .

```{r, echo = F}
summaryTiming |> tableCohortTiming(timeScale = "years")
```

## plotCohortTiming

. . .

```{r, eval = F}
summaryTiming |>
  plotCohortTiming(
    timeScale = "years", 
    facet = "cdm_name", 
    colour = c("cohort_name_reference", "cohort_name_comparator"))
```

. . .

```{r, echo = F}
summaryTiming |>
  plotCohortTiming(
    timeScale = "years", 
    facet = "cdm_name", 
    colour = c("cohort_name_reference", "cohort_name_comparator"))
```

## plotCohortTiming

. . .

```{r, error = TRUE}
summaryTiming |>
  plotCohortTiming(
    plotType = "density",
    timeScale = "years", 
    facet = "cdm_name", 
    colour = c("cohort_name_reference", "cohort_name_comparator"))
```

. . .

```{r, echo=FALSE}
summaryTiming |>
  plotCohortTiming(
    plotType = "density",
    timeScale = "years", 
    facet = "cdm_name", 
    colour = c("cohort_name_reference", "cohort_name_comparator"))
```

## Your turn

Can you do a density plot of the three cohorts that you created before (for the overlap exercise)?

## Your turn

```{r, echo = FALSE}
cdm$my_cohort |> 
  summariseCohortTiming() |>
  plotCohortTiming(
    plotType = "density",
    timeScale = "years", 
    facet = "cdm_name", 
    colour = c("cohort_name_reference", "cohort_name_comparator"))
```

## Let's get started

```{r, echo = FALSE}
options("width"=130)
```

```{r, echo = TRUE}
library(duckdb)
library(CDMConnector)
library(PatientProfiles)
library(dplyr)
library(ggplot2)

con <- dbConnect(duckdb(), eunomia_dir())
cdm <- cdmFromCon(con = con, cdmSchema = "main", writeSchema = "main")
cdm <- generateConceptCohortSet(
  cdm = cdm,
  name = "sinusitis",
  conceptSet = list(
    "bacterial_sinusitis" = 4294548, 
    "viral_sinusitis" = 40481087, 
    "chronic_sinusitis" = 257012, 
    "any_sinusitis" = c(4294548, 40481087, 257012)
  ), 
  limit = "all", 
  end = 0
)
cdm$new_sinusitis <- cdm$sinusitis |>
  addSex() |>
  filter(sex == "Female") |>
  select(-"sex") |>
  compute(name = "new_sinusitis", temporary = F) |>
  recordCohortAttrition("Restrict to Females") |>
  addAge() |>
  filter(age < 18) |>
  select(-"age") |>
  compute(name = "new_sinusitis", temporary = F) |>
  recordCohortAttrition("Restrict to under 18")

cdm <- generateConceptCohortSet(
  cdm = cdm, 
  conceptSet = list(
    "myocardial_infarction" = c(4329847),
    "fracture" = c(4048695, 4142905, 4278672, 4237458, 4230399, 40480160, 4066995, 4059173, 4134304),
    "allergy" = c(4084167, 40486433, 4280726, 4048171),
    "infection" =  c(4116491, 433125, 4056621, 40481087, 4112343),
    "pneumonia" = c(255848),
    "asthma" = c(4051466, 317009)
  ),
  limit = "all",
  end = 0,
  name = "conditions"
)

cdm <- generateConceptCohortSet(
  cdm = cdm, 
  conceptSet = list(
    "antineoplastic_and_immunomodulating_agents" = c(1118088, 1118084, 40224132, 19010482, 40224805, 19007333, 1500211, 1305058, 1503184, 19134077, 1549786),
    "musculoskeletal_system" = c(1118088, 1557272, 40162359, 1124300, 1115008, 40173590, 1118084, 42707627, 19019273, 19019979, 19078461, 19003953, 1112807, 1115171, 1177480),
    "antiinfectives_for_systemic_use" = c(19129655, 1728416, 920293, 19074841, 920300, 920334, 19074843, 19075001, 19073183, 19073188, 1713671, 1729720, 19006318, 1778162, 46275444, 1717327, 1738521, 1741122, 1759842, 1713332, 1746114, 1768849, 46233710, 19133873, 46233988, 19133905),
    "nervous_system" = c(708298, 701322, 723013, 1129625, 1110410, 753626, 1124957, 1102527, 1125315, 782043, 791967, 1119510, 19078219, 757627, 40220386, 740275, 40223774, 1154029, 1127078, 1127433, 40222846, 19057271, 40223768, 45892894, 705944, 715997, 19078924, 19076374, 19077572, 40229134, 19059056, 19016749, 40236446, 19074679, 742185, 40231925, 1112807, 35605858, 40162522, 782047, 19039298, 19059528, 836654, 836659, 19115351, 19023398, 19002770, 19123231, 19133768, 40165015),
    "dermatologicals" = c(1129625, 1149380, 1124300, 836654, 1595799, 975125, 19008572),
    "respiratory_system" = c(1129625, 1149196, 1149380, 1150770, 1150836, 1153428, 1107830, 1110410, 738818, 1124957, 40169216, 1125443, 1119510, 1137529, 1154615, 1154343, 40223821, 19019979, 19112599, 40223834, 43012036, 40229134, 19029476, 19078461, 40232448, 1177480, 1192710, 1343916, 1150771, 1150837, 1107882, 975125, 1174888, 40169281, 40228214, 40228230, 19125062)
  ),
  limit = "all",
  end = "event_end_date",
  name = "medications"
)
```

## summariseCharacteristics

. . .

```{r, echo = T, eval = F}
library(CohortCharacteristics)

cdm$new_sinusitis |>
  addAge(ageGroup = list(c(0, 4), c(5, 9), c(10, 14), c(15, 18))) |>
  summariseCharacteristics(
    strata = list("age_group"),
    demographics = TRUE,
    ageGroup = list(c(0, 4), c(5, 9), c(10, 14), c(15, 18)),
    tableIntersectCount = list(
      "Number of visits prior year" = list(
        tableName = "visit_occurrence", window = c(-365, 0)
      )
    ),
    cohortIntersectFlag = list(
      "Conditions any time prior" = list(
        targetCohortTable = "conditions", window = c(-Inf, 0)
      ),
      "Medications prior year" = list(
        targetCohortTable = "medications", window = c(-365, 0)
      )
    )
  )
```

## summariseCharacteristics

```{r, echo = F, eval = T}
library(CohortCharacteristics)

cdm$new_sinusitis |>
  addAge(ageGroup = list(c(0, 4), c(5, 9), c(10, 14), c(15, 18))) |>
  summariseCharacteristics(
    strata = list("age_group"),
    demographics = TRUE,
    ageGroup = list(c(0, 4), c(5, 9), c(10, 14), c(15, 18)),
    tableIntersectCount = list(
      "Number of visits prior year" = list(
        tableName = "visit_occurrence", window = c(-365, 0)
      )
    ),
    cohortIntersectFlag = list(
      "Conditions any time prior" = list(
        targetCohortTable = "conditions", window = c(-Inf, 0)
      ),
      "Medications prior year" = list(
        targetCohortTable = "medications", window = c(-365, 0)
      )
    )
  ) |>
  glimpse()
```

## tableCharacteristics

```{r, echo = F, eval = T}
result <- cdm$new_sinusitis |>
  addAge(ageGroup = list(c(0, 4), c(5, 9), c(10, 14), c(15, 18))) |>
  summariseCharacteristics(
    strata = list("age_group"),
    demographics = TRUE,
    ageGroup = list(c(0, 4), c(5, 9), c(10, 14), c(15, 18)),
    tableIntersectCount = list(
      "Number of visits prior year" = list(
        tableName = "visit_occurrence", window = c(-365, 0)
      )
    ),
    cohortIntersectFlag = list(
      "Conditions any time prior" = list(
        targetCohortTable = "conditions", window = c(-Inf, 0)
      ),
      "Medications prior year" = list(
        targetCohortTable = "medications", window = c(-365, 0)
      )
    )
  )
```

```{r}
result |>
  tableCharacteristics(
    header = "age_group", 
    groupColumn = "cohort_name", 
    hide = c("table", "window", "value"))
```

## tableCharacteristics

```{r, eval = F}
result |>
  filter(group_level == "any_sinusitis") |>
  filter(estimate_name %in% c("count", "percentage", "median", "q25", "q75")) |>
  tableCharacteristics(
    header = c("age_group"),
    hide = c("table", "window", "value", "cdm_name")
  )
```

## tableCharacteristics

```{r, eval = T, echo = F}
result |>
  filter(group_level == "any_sinusitis") |>
  filter(estimate_name %in% c("count", "percentage", "median", "q25", "q75")) |>
  tableCharacteristics(
    header = c("age_group"),
    hide = c("table", "window", "value", "cdm_name")
  )
```

## export gt tables

[gt](https://gt.rstudio.com/) tables can easily be exported to word:

```{r, eval=T, echo = F}
myTable <- result |>
  filter(group_level == "any_sinusitis") |>
  filter(estimate_name %in% c("count", "percentage", "median", "q25", "q75")) |>
  tableCharacteristics(
    header = c("age_group"),
    hide = c("table", "window", "value", "cdm_name")
  )
```

```{r, eval = F, echo = T}
myTable |> 
  gt::gtsave("table.docx")
```

## plotCharacteristics

```{r}
result |>
  filter(variable_name == "Age" & strata_level == "overall") |>
  plotCharacteristics(plotStyle = "boxplot", colour = "cohort_name")
```

## plotCharacteristics

```{r}
result |>
  filter(
    variable_name == "Conditions any time prior" & 
      strata_level == "overall" &
      estimate_name == "percentage"
  ) |>
  plotCharacteristics(colour = "cohort_name", facet = "variable_level")
```

## Your turn

Can you summarise the characteristics for conditions cohort and include the % of subjects that took the medications in the medications cohort after record of the conditions? Also create a gt table?

## Solution

```{r}
results <- cdm$conditions |> 
  summariseCharacteristics(
    demographics = TRUE,
    cohortIntersectFlag = list("Medications anytime after" = list(
      targetCohortTable = "medications", window = c(1, Inf)
    ))
  )

print(results)
```

## Plot solution

```{r}
result |>
  filter(estimate_name %in% c("count", "percentage", "median", "q25", "q75")) |>
  tableCharacteristics(header = "cdm_name", groupColumn = "cohort_name")
```

## summariseLargeScaleCharacterisation

```{r}
result <- cdm$sinusitis |>
  summariseLargeScaleCharacteristics(
    window = list(c(-Inf, -1), c(1, Inf)),
    eventInWindow = "condition_occurrence",
    #episodeInWindow = "drug_exposure",
    minimumFrequency = 0.05
  )
result |> 
  glimpse()
```

## tableLargeScaleCharacteristics

```{r}
tableLargeScaleCharacteristics(result, topConcepts = 10)
```

## plotLargeScaleCharacteristics

```{r, eval = F}
p <- result |>
  plotLargeScaleCharacteristics(facet = "variable_level", colour = "cohort_name") +
  xlab("") +
  ylab("Percentage") +
  theme_minimal() +
  theme(legend.position = "top", legend.title = element_blank())
plotly::ggplotly(p)
```

## plotLargeScaleCharacteristics

```{r, echo = F}
p <- result |>
  plotLargeScaleCharacteristics(facet = "variable_level", colour = "cohort_name") +
  xlab("") +
  ylab("Percentage") +
  theme_minimal() +
  theme(legend.position = "top", legend.title = element_blank())
plotly::ggplotly(p)
```

## plotComparedLargeScaleCharacteristics

```{r}
p <- result |>
  filter(group_level == "any_sinusitis") |>
  plotComparedLargeScaleCharacteristics(reference =  c(variable_level = "-inf to -1")) +
  theme(legend.position = "none") 
p |>
  plotly::ggplotly()
```

## Your turn

Can you do a large scale characterisation for the patients in sinusitis table with drug exposures, with time window any time prior record of sinusitis? Also plot the results?

## solution

```{r}
result <- cdm$sinusitis |>
  summariseLargeScaleCharacteristics(
    window = c(-Inf, -1),
    episodeInWindow = "drug_exposure",
    minimumFrequency = 0.05
  )
```

## plot solution

```{r}
result |>
  plotLargeScaleCharacteristics(facet = "variable_level", colour = "cohort_name") +
  xlab("") +
  ylab("Percentage") +
  theme_minimal() +
  coord_flip() +
  theme(legend.position = "top", legend.title = element_blank())
```

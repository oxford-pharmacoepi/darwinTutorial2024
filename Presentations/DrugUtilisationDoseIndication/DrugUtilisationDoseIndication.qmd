---
pagetitle: "DrugUtilisation"
format:
  revealjs: 
    theme: [simple, styleOU.scss]
    incremental: true   
    slide-number: true
    chalkboard: true
    preview-links: auto
    margin: 0.07
    code-link: true
    code-line-numbers: false
    height: 900
    width: 1600
    footer: "Conducting 'Off-The-Shelf' Characterization Studies Using DARWIN EU Tools and the OMOP CDM"
execute:
  echo: true
  eval: true
  warning: false
  output-width: 100%
editor: visual
---

# DrugUtilisation

Drug cohort creation

## Introduction

Drug utilisation studies (DUS) were defined by the World Health Organization as studying the marketing, distribution, prescription, and use of medicinal products in a society, with special emphasis on the resulting medical and socioeconomic consequences (WHO, 2003).

. . .

This package aims to standardise and provide the tools to conduct Drug Utilisation studies as of the Darwin-EU Catalogue of Standard Analytics.

![](https://www.darwin-eu.org/templates/rt_horizon/custom/images/darwin-eu-logo.png){fig-align="center" width="45%"}

## Content

-   Cohort creation

-   **Summarise dose usage**

-   **Summarise indications**

-   **Summarise treatment persistence**

-   **Summarise drug restart and drug switching**

-   **Summarise treatments**

## The package

<br>

```{r, eval=FALSE}
install.packages("DrugUtilisation")
```

<br>

-   [v0.7.1](https://cran.r-project.org/package=DrugUtilisation) on cran.

-   [package website](https://darwin-eu-dev.github.io/DrugUtilisation/)

-   [Report an issue/Feature request](https://github.com/darwin-eu-dev/DrugUtilisation/issues/new)

## Create a reference to a cdm object

For this example we are going to use

```{r}
library(DBI)
library(duckdb)
library(CDMConnector)
library(dplyr)
library(here)

db <- dbConnect(duckdb(), dbdir = eunomia_dir())
cdm <- cdmFromCon(con = db, cdmSchema = "main", writeSchema = "main")
```

## Fix eunomia problems with drugs

Add a drug_strength table:

```{r}
x <- read.csv("https://raw.githubusercontent.com/darwin-eu-dev/DrugUtilisation/main/extras/mock_drug_strength.csv")
cdm <- insertTable(cdm = cdm, name = "drug_strength", table = x)
```

. . .

Fix quantity:

```{r}
cdm$drug_exposure <- cdm$drug_exposure |>
  mutate(quantity = days_supply) |>
  compute(name = "drug_exposure", temporary = FALSE)
```

## Generate the drug cohort

```{r, message=FALSE}
library(CodelistGenerator)
library(DrugUtilisation)
codelist <- getDrugIngredientCodes(cdm = cdm, name = "acetaminophen")
cdm <- generateDrugUtilisationCohortSet(
  cdm = cdm,
  name = "dus_cohort",
  conceptSet = codelist,
  gapEra = 30
)
```

## Drug usage

```{r}
result <- cdm$dus_cohort |>
  summariseDrugUtilisation(
    ingredientConceptId = , 
    conceptSet = codelist,
    indexDate = "cohort_start_date",
    censorDate = "cohort_end_date", 
    restrictIncident = TRUE, 
    gapEra = 30, 
    numberExposures = TRUE, 
    numberEras = TRUE, 
    exposedTime = TRUE, 
    timeToExposure = FALSE, 
    initialQuantity = TRUE, 
    cumulativeQuantity = TRUE, 
    initialDailyDose = TRUE, 
    cumulativeDose = TRUE
  )
```

## Drug usage

```{r}
tableDrugUtilisation(result)
```

## Indications

`summariseIndication()`:

- To summarise **mutually exclusive** indications.

- Define a window respect to the 'cohort_start_date'.

- Indications must be instantiated beforehand as cohorts. 

- Unknown indication (check a table to see if there is a record).

## Indications

Let's instantiate the cohorts of interest:

```{r}

```

## Indciations

```{r}
result <- cdm$dus_cohort |>
  summariseIndication(
    indicationCohortName = "indications", 
    indicationWindow = list(c(0, 0), c(-30, 7)), 
    unknownIndicationTable = "condition_occurrence"
  )
```

## Indications

```{r}
tableIndication(result)
```

## Indications

```{r}
plotIndication(result)
```

## Treatment persistence

To analyse treatment persistence and adherence there are two standard pipelines:

- Survival analysis (implemented in the [CohortSurvival](https://cran.r-project.org/package=CohortSurvival) package)

- Proportion of patients covered

## Proportion of patients covered

Proportion of treated individuals between index date and `followUpDays`. Percentages will be reported daily.

```{r}
result <- cdm$dus_cohort |>
  summariseProportionOfPatientsCovered(followUpDays = 90)
```

## Proportion of patients covered

```{r}
tableProportionOfPatientsCovered(result)
```

## Proportion of patients covered

```{r}
plotProportionOfPatientsCovered(result)
```

## Drug restart and drug switching

We have the ability to study drug restart or drug switching after a discontinuation:

- Switching cohorts must be defined in advance.

- We have to define the windows of interest.

- Index date will be the date of discontinuation.

- Reported percentages in each window will be:

 - *Restart*: individuals that restarted and not switched.
 - *Switch*: individuals that switched and not restarted.
 - *Restart and switch*: individuals that restarted and switched.
 - *Untreated*: individuals that did not restart or switch.

## Drug restart and drug switching

Let's define the cohorts of interest for switching:

```{r}

```

## Drug restart and drug switching

```{r}
result <- cdm$dus_cohort |>
  summariseDrugRestart(
    switchCohortTable = "switch", 
    followUpDays = c(90, 180, 270, 360), 
    restrictToFirstDiscontinuation = TRUE
  )
```

## Drug restart and drug switching

```{r}
tableDrugRestart(result)
```

## Drug restart and drug switching

```{r}
plotDrugRestart(result)
```

## Summarise treatments

`summariseTreatment()` is a general function
